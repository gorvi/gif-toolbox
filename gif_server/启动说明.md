# 后端启动说明

## 启动步骤

### 1. 进入后端目录
```bash
cd gif_server
```

### 2. 安装依赖（如果还没安装）
```bash
npm install
```

### 3. 编译 TypeScript（如果还没编译）
```bash
npm run build
```

### 4. 启动 API 服务
```bash
npm run start:api
```

或者直接运行编译后的文件：
```bash
node dist/api/index.js
```

### 5. 启动 Worker 服务（处理任务，**必须启动**）
```bash
npm run start:worker
```

**重要**：Worker 服务必须启动，否则任务会一直处于 `QUEUED` 状态，无法处理！

## 开发模式（自动重新编译）

```bash
# 启动 API（开发模式，自动重新编译）
npm run dev:api

# 启动 Worker（开发模式，自动重新编译）
npm run dev:worker
```

## 检查服务是否启动成功

### API 服务
启动成功后，应该看到：
```
[api] listening on 0.0.0.0:3001
```

然后在浏览器访问：
- `http://localhost:3001/healthz` → 应该返回 `{"ok":true}`
- `http://192.168.71.117:3001/healthz` → 应该返回 `{"ok":true}`

### Worker 服务
启动成功后，应该看到：
```
[worker] started
```

Worker 会持续运行，处理队列中的任务。如果没有看到这个日志，说明 Worker 没有启动，任务将无法被处理。

## 常见问题

### 1. 端口被占用
如果 3001 端口被占用，可以设置环境变量：
```bash
# Windows PowerShell
$env:PORT=3002
npm run start:api

# Windows CMD
set PORT=3002
npm run start:api
```

### 2. 没有日志输出
- 检查是否有编译错误：`npm run build`
- 检查 Node.js 版本（需要 Node.js 18+）
- 检查是否有其他错误信息

### 3. 无法访问 IP 地址
- 确保后端监听在 `0.0.0.0`（代码已配置）
- 检查防火墙是否阻止了 3001 端口
- 检查 Windows 防火墙设置

### 4. 任务一直处于 QUEUED 状态，不处理
**原因**：Worker 服务没有启动

**解决**：
1. 检查 Worker 服务是否在运行（应该看到 `[worker] started` 日志）
2. 如果没有运行，启动 Worker：
   ```bash
   npm run start:worker
   ```
   或开发模式：
   ```bash
   npm run dev:worker
   ```
3. 确保 Worker 和 API 服务都在运行（需要两个终端窗口）


