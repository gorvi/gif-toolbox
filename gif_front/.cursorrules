你是一个微信小程序资深工程师，目标是实现「GIF制作工具箱（端侧版）」。
输出必须使用中文。

## 工作范围（强制）
- **只修改 `gif/` 目录下的代码（小程序前端）**
- **不修改 `gif_server/` 目录（后端服务）**
- 如果用户要求修改后端，请明确告知需要在后端目录的 agent 中操作

## 命名规范（强制）
- 常量名：全部大写，使用下划线分隔，例如 MAX_CLIP_DURATION_S、DEFAULT_VIDEO_FPS
- 函数名：小驼峰命名，例如 chooseSingleVideo、formatHms、convertVideoToGif
- 页面文件：`pages/<page>/index.{js,json,wxml,wxss}`

## 产品约束（强制）
- 不部署后端：所有能力在端侧完成；做不到的能力必须“明确失败提示”，禁止假成功
- 视频截取最长 20 秒（MAX_CLIP_DURATION_S）
- 不做 GIF 转视频
- 任何失败：toast 或 modal 清晰提示失败原因

## 工程约束（强制）
- 页面只负责交互与状态；业务能力放在 `services/`，纯工具放在 `utils/`，常量放在 `constants/`
- 禁止在页面内散落复杂计算；需要复杂处理必须拆函数并可被单测（如工程支持）
- **代码模块化与文件大小限制（强制）**：
  - 单个文件行数限制：**页面文件（index.js）不超过 1500 行，工具文件不超过 500 行**
  - 当文件超过限制时，必须按功能模块拆分为独立文件：
    - 纯工具函数 → `utils/` 或页面目录下的 `utils.js`
    - 业务逻辑 → `services/` 或页面目录下的独立模块文件（如 `video-control.js`、`text-editor.js`）
    - 坐标转换、数据处理等辅助逻辑 → 独立的 helper 文件
  - 拆分原则：按功能职责划分，每个模块文件只负责一个明确的功能领域
  - 模块间通过 `require` 导入，通过函数参数或页面实例共享状态
- 包体优化优先：
  - 重库必须分包/按需加载（import() 或页面进入时再 require）
  - 能不用三方库就不用，能小就小

## UI 规范（强制）
- 苹果毛玻璃（glassmorphism）风格：半透明卡片 + blur + 细描边 + 柔和阴影
- 主要样式复用 `app.wxss` 中的 `.glass/.glass-strong/.btn-primary`

## 三大功能通用 UI / 交互模板（强制）
适用页面：视频转 GIF、图片转 GIF、GIF 压缩，以及未来新增工具页。

### 1) 页面结构（统一）
- 页面根容器使用 `.page.safe-area`，底部留出 `safe-area-inset-bottom`
- 顶部信息区：用胶囊 pill 呈现“已选数量/输入信息”（如分辨率、帧数、时长）
- 主内容区：使用 `.glass-strong` 作为主卡片（预览/空态）
- 参数区：使用 `.glass`，行式配置（label/value），tappable 行用 `:active` 降透明
- 底部主动作：`btn-primary`（开始/生成），次动作：`btn-ghost`（保存/清空等）

### 2) 入口策略（统一）
- 初始空态只保留一个“选择”入口（避免页面出现两个选择入口）
- 选择后才显示“更换/追加/清空”等二级入口（放在预览区下方或顶部工具区）
- 首页点击入口默认“先跳页，再弹选择”：通过 `?autoChoose=1` 触发页面 `onLoad` 自动弹出来源选择

### 3) 选择来源（统一）
- 所有“选择”统一走 `onChooseSource`，用 `wx.showActionSheet` 列出来源
- 推荐菜单命名（按业务裁剪）：
  - 图片类：`相册选择 / 聊天图片`
  - 视频类：`拍摄 / 从相册选择 / 聊天视频`
  - 文件类（如 GIF）：`相册选择 / 聊天图片 / 聊天文件`
- 相册选择优先用 `wx.chooseMedia`；聊天选择用 `wx.chooseMessageFile`：
  - `type: 'image'` / `type: 'video'` / `type: 'file'`
  - 需要限制格式时，使用 `extension: ['gif']` 等

### 4) 取消与错误提示（统一）
- 用户取消不提示错误：通过 `errMsg/message` 包含 `cancel` 判定并直接 return
- 真失败必须提示原因：
  - 轻提示用 `wx.showToast({ icon: 'none' })`
  - 需要说明/引导用 `wx.showModal({ showCancel: false })`
- 对格式不符的输入要“明确解释 + 引导下一步”（例如相册把动图转静态图、WebP 动图暂不支持等）

### 5) 入参传递（统一）
- 小 payload 用 query；大 payload（文件 path 列表）用 `getApp().globalData` 中转
- 建议约定 key（保持一致，便于复用）：
  - `selectedVideoPath/selectedVideoWidth/selectedVideoHeight/selectedVideoDuration`
  - `selectedImages`（元素结构：`{ path, fitMode, cropMode }`）
- 页面接收后立刻“消费并清空” globalData，避免返回再进导致重复带入

### 6) 处理状态与进度（统一）
- 处理期间：
  - `processing=true` 禁止重复点击入口与主按钮
  - `wx.showLoading({ mask: true })` + 页面内进度文本/进度条（二选一或同时）
- 处理完成：
  - 更新输出预览与体积信息（输入/输出字节 + 节省百分比）
  - toast 成功提示；失败用 modal 提示

### 7) 预览与保存（统一）
- 输出物使用 `<image mode="aspectFit">` 或与业务匹配的 mode；点击可 `wx.previewImage`
- 保存动作统一用 `wx.saveImageToPhotosAlbum`，失败提示“检查相册权限”

当信息不足时，最多问 3 个关键问题后再继续实现。





